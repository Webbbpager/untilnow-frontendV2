<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Centralized SEO Meta via JS -->
    <script src="../static/meta.js"></script>
    <script>
    setMeta({
        title: "Pel√≠culas y Series Resumidas ‚Äì Personalizado y Sin Spoilers | UntilNow",
        description: "Crea res√∫menes personalizados y sin spoilers para pel√≠culas y series. Elige desde episodio hasta episodio o escena a escena, ¬°sin spoilers!",
        keywords: "resumen de serie, resumen de pel√≠cula, sin spoilers, personalizado, escena, episodio, resumen TV, UntilNow",
        ogTitle: "Pel√≠culas y Series Resumidas ‚Äì Personalizado y Sin Spoilers",
        ogDescription: "Res√∫menes sin spoilers para pel√≠culas y series: elige hasta d√≥nde quieres ponerte al d√≠a.",
        ogUrl: "https://untilnow.xyz/es/video.html",
        ogImage: "https://untilnow.xyz/untilnow-banner.png",
        twitterTitle: "Resumen de Pel√≠culas y Series ‚Äì Personalizado y Sin Spoilers | UntilNow",
        twitterDescription: "Crea res√∫menes personalizados y sin spoilers para pel√≠culas y series.",
        canonical: "https://untilnow.xyz/es/video.html",
        hreflang: {
            de: "https://untilnow.xyz/video.html",
            en: "https://untilnow.xyz/en/video.html",
            es: "https://untilnow.xyz/es/video.html",
            fr: "https://untilnow.xyz/fr/video.html"
        }
    });
    </script>

    <!-- Favicon & CSS -->
    <link rel="icon" href="../faviUntilNow.png" type="image/png">
    <link rel="stylesheet" href="../style.css">

    <style>
        body { max-width: 540px; margin: 0 auto; padding: 2em; background: #fafbfc; position:relative;}
        .input-row { margin-bottom: 1.3em; }
        label { font-weight: bold; display: block; margin-bottom: 0.5em; }
        input[type=text], select { width: 100%; padding: 0.6em; border: 1px solid #ccc; border-radius: 8px; font-size:1em;}
        .main-btn { padding: 1em 2em; font-size: 1.15em; border-radius: 12px; cursor: pointer; border: none; background: #2266bb; color: white; width: 100%; margin: 1.2em 0 0.7em 0; }
        .main-btn[disabled] { opacity: 0.7; }
        .amazon-btn, .prime-btn {
            border-radius: 9px; font-size: 1.09em; font-weight: 500; border: none; padding: 0.7em 1.3em; display: flex; align-items: center; gap:0.4em; cursor:pointer;
            margin: 0 0.7em 0 0;
        }
        .amazon-btn { background: #ff9900; color: #fff; }
        .amazon-btn:hover { background: #ffad32; }
        .prime-btn { background: #0066c8; color: #fff; }
        .prime-btn:hover { background: #2187e7; }
        .buy-btn-row { display: flex; gap:0.6em; margin: 1em 0 0.7em 0; justify-content: flex-start;}
        .spinner { display:inline-block; width: 1.5em; height: 1.5em; border: 2px solid #fff; border-top: 2px solid #2266bb; border-radius: 50%; animation: spin 0.7s linear infinite; vertical-align: middle; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .powered { font-size: 0.9em; color: #aaa; margin-top: 2em; text-align: right; }
        .topbar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5em; }
        #lang-menu { position: static; }
        #lang-btn { cursor: pointer; font-size: 2em; }
        /* Language Popup Modal */
        #lang-modal-bg {
            display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); z-index:99; justify-content:center; align-items:center;
        }
        #lang-dropdown {
            display: none; position:relative; min-width:220px; background: white; border: 1px solid #ddd; border-radius: 13px; box-shadow: 0 8px 24px #0001;
            padding:0.7em 0; font-size:1.2em;
            animation:pop 0.14s cubic-bezier(.46,.53,.55,.96);
        }
        #lang-dropdown div { padding: 0.7em 1.7em; cursor: pointer;}
        #lang-dropdown div:hover { background: #eef3fa; }
        #backBtn { font-size:2em; color:#2266bb; text-decoration:none; transition:color 0.2s;}
        #backBtn:hover { color:#113366; }
        .ep-box { display:inline-block; margin:2px; padding:4px 8px; border-radius:5px; background:#e3e8f1; cursor:pointer; min-width:28px; text-align:center; }
        .ep-box.selected { background:#3b82f6; color:white; font-weight:bold; }
        .chip { display:inline-block; background:#e5eaf4; border-radius:999px; padding:0.25em 1.1em; margin:0.4em 0; font-size:1.05em; cursor:pointer; border:1px solid #c9d5e8; transition: box-shadow 0.15s; }
        .chip:hover { box-shadow: 0 2px 8px #4a90e21f; background:#d0e4fa;}
        .autocomplete-item { padding: 0.7em 1.2em; cursor: pointer; }
        .autocomplete-item:hover { background: #eef3fa; }
        #autocomplete { position:absolute; left:0; right:0; top:3em; background:white; border-radius:0 0 9px 9px; box-shadow:0 8px 32px #0002; z-index:10; display:none;}

        /* Slider Styles */
        .single-range {
            width: 100%;
            appearance: none;
            height: 7px;
            background: #e4eafd;
            border-radius: 8px;
            outline: none;
            margin-top: 0.6em;
            margin-bottom: 0.2em;
            transition: background 0.2s;
        }
        .single-range::-webkit-slider-thumb {
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #2266bb;
            border: 3px solid #fff;
            box-shadow: 0 2px 8px #2266bb22;
            cursor: pointer;
            transition: background 0.18s;
        }
        .single-range:focus::-webkit-slider-thumb {
            outline: 2px solid #113366;
        }
        .single-range::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #2266bb;
            border: 3px solid #fff;
            box-shadow: 0 2px 8px #2266bb22;
            cursor: pointer;
            transition: background 0.18s;
        }
        .single-range:focus::-moz-range-thumb {
            outline: 2px solid #113366;
        }
        .single-range::-ms-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #2266bb;
            border: 3px solid #fff;
            box-shadow: 0 2px 8px #2266bb22;
            cursor: pointer;
            transition: background 0.18s;
        }
        .single-range::-webkit-slider-runnable-track,
        .single-range::-ms-fill-lower,
        .single-range::-ms-fill-upper,
        .single-range::-moz-range-track {
            height: 7px;
            background: transparent;
        }
        .single-range:focus {
            outline: none;
        }
        .range-values {
            display: flex;
            justify-content: flex-end;
            font-size: 1.08em;
            color: #38619e;
            padding: 0.1em 0.1em 0 0.1em;
            font-weight: 500;
        }
        .double-slider-wrap {
            width: 100%; margin: 1.4em 0 0.9em 0;
        }
        .double-slider-labels {
            display: flex; justify-content: space-between; font-size: 1em; margin-bottom: 0.5em; color: #4a6791;
        }
        @keyframes pop { 0% { transform:scale(0.6); opacity:0.4 } 100% { transform:scale(1); opacity:1; } }
        @media (max-width: 600px) {
            body { padding: 0.8em; }
            .topbar { margin-bottom: 1em; }
            .buy-btn-row { flex-direction: column; gap:0.7em; }
        }
    </style>
</head>
<body>
    <div class="topbar">
        <a href="/static/index.html" id="backBtn" title="Zur√ºck">&#8592;</a>
        <div id="lang-menu">
            <span id="lang-btn">üåê</span>
        </div>
    </div>
    <div id="lang-modal-bg">
        <div id="lang-dropdown">
            <div data-lang="de">üá©üá™ Deutsch</div>
            <div data-lang="en">üá¨üáß English</div>
            <div data-lang="es">üá™üá∏ Espa√±ol</div>
            <div data-lang="fr">üá´üá∑ Fran√ßais</div>
        </div>
    </div>

    <h1 id="header">üé¨ Video-Zusammenfassung</h1>
    <div class="input-row" style="position:relative;">
        <label id="inputLabel" for="title">üéûÔ∏è <span id="inputPlaceholder">Titel eingeben</span></label>
        <input type="text" id="title" autocomplete="off">
        <div id="autocomplete"></div>
    </div>
    <div id="noResult" style="color:#b22; margin-top:1em; display:none; font-weight:bold;"></div>
    <div id="selectRow" class="input-row" style="display:none;">
        <label id="selectLabel"></label>
        <select id="selectMatch"></select>
    </div>
    <div class="buy-btn-row" id="buyBtnRow" style="display:none;">
        <button class="amazon-btn" id="amazonBtn" target="_blank">
            <img src="https://upload.wikimedia.org/wikipedia/commons/a/a9/Amazon_logo.svg" alt="Amazon" style="height:1.1em;"> <span id="amazonBtnText">Bei Amazon kaufen</span>
        </button>
        <button class="prime-btn" id="primeBtn" target="_blank">
            <img src="https://upload.wikimedia.org/wikipedia/commons/e/e3/Amazon_Prime_Logo.svg" alt="Prime" style="height:1.2em;"> <span id="primeBtnText">Auf Prime ansehen</span>
        </button>
    </div>
    <div id="detailsSection" style="display:none;">
        <div class="input-row">
            <label id="detailLabel">üîç <span id="detailText">Detailgrad</span></label>
            <select id="detail">
                <option value="grob">üìù <span id="shortText">Kurz</span></option>
                <option value="detailliert">üìÑ <span id="detailedText">Detailliert</span></option>
            </select>
        </div>
        <!-- FILM: Zwei unabh√§ngige Slider -->
        <div id="filmSliderSection" class="input-row" style="display:none;">
            <label id="filmRangeLabel"></label>
            <div class="double-slider-wrap">
                <div style="margin-bottom:1.1em;">
                    <label for="slider-1" id="filmFromText" style="color:#4a6791;"></label>
                    <input type="range" min="1" max="120" value="1" id="slider-1" class="single-range">
                    <div class="range-values"><span id="range1">1</span></div>
                </div>
                <div style="margin-bottom:0.8em;">
                    <label for="slider-2" id="filmToText" style="color:#4a6791;"></label>
                    <input type="range" min="1" max="120" value="120" id="slider-2" class="single-range">
                    <div class="range-values"><span id="range2">120</span></div>
                </div>
            </div>
            <div class="input-row">
                <label id="filmSceneLabel"></label>
                <input type="text" id="filmSceneInput" placeholder="">
            </div>
            <button class="main-btn" id="summaryBtnFilm" style="margin-top:1em;">
                <span id="summarizeText">üß† Zusammenfassung erstellen</span>
                <span id="summarizeSpinner" style="display:none;" class="spinner"></span>
            </button>
        </div>
        <!-- SERIE: Von-Bis Stepper (unver√§ndert) -->
        <div id="seriesSection" style="display:none;">
            <div id="fromBlock">
                <label id="seriesFromText"></label>
                <div id="fromSeasonRow"></div>
                <div id="fromEpisodeRow" style="margin-top:0.5em;"></div>
                <div style="margin-top:0.6em;">
                    <label id="seriesSceneLabelFrom" style="font-weight:normal;"></label>
                    <input type="text" id="seriesSceneInputFrom" placeholder="">
                </div>
                <button class="main-btn" id="fromConfirmBtn" style="display:none;">Weiter</button>
            </div>
            <div id="fromSummary" style="display:none;">
                <span class="chip" id="fromChip" title="Bearbeiten"></span>
            </div>
            <div id="toBlock" style="display:none;">
                <label id="seriesToText"></label>
                <div id="toSeasonRow"></div>
                <div id="toEpisodeRow" style="margin-top:0.5em;"></div>
                <div style="margin-top:0.6em;">
                    <label id="seriesSceneLabelTo" style="font-weight:normal;"></label>
                    <input type="text" id="seriesSceneInputTo" placeholder="">
                </div>
                <button class="main-btn" id="toConfirmBtn" style="display:none;">Weiter</button>
            </div>
            <div id="toSummary" style="display:none;">
                <span class="chip" id="toChip" title="Bearbeiten"></span>
            </div>
            <button class="main-btn" id="summaryBtnSeries" style="display:none;margin-top:1.5em;">
                <span id="summarizeText">üß† Zusammenfassung erstellen</span>
                <span id="summarizeSpinner" style="display:none;" class="spinner"></span>
            </button>
        </div>
    </div>
    <div id="summarySection" style="margin-top:2em; display:none;">
        <h2 id="summaryLabel">üìù Zusammenfassung</h2>
        <div id="summaryTextResult"></div>
        <button class="main-btn" id="ttsBtn" style="width:auto;"><span id="ttsText">üîä Vorlesen</span> <span id="ttsSpinner" style="display:none;" class="spinner"></span></button>
    </div>
    <div class="powered">üìå Powered by Gemini, TMDB & gTTS</div>
    <script>
        // Amazon Affiliate Links (change &tag= for your affiliate id)
        const AMAZON_AFFILIATE_PREFIX = "https://www.amazon.de/s?k=";
        const PRIME_AFFILIATE_PREFIX = "https://www.amazon.de/s?i=instant-video&k=";

        // √úbersetzungen
        const texts = {
            header: { de: "üé¨ Zusammenfassung", en: "üé¨ Summary", es: "üé¨ Resumen", fr: "üé¨ R√©sum√©" },
            input: { de: "Titel eingeben", en: "Enter title", es: "Introduce el t√≠tulo", fr: "Entrez le titre" },
            select_prompt: { de: "Passenden Titel w√§hlen:", en: "Select matching title:", es: "Selecciona el t√≠tulo correcto:", fr: "S√©lectionnez le titre correspondant :" },
            detail_label: { de: "Detailgrad", en: "Level of detail", es: "Nivel de detalle", fr: "Niveau de d√©tail" },
            short: { de: "Kurz", en: "Brief", es: "Breve", fr: "Bref" },
            detailed: { de: "Detailliert", en: "Detailed", es: "Detallado", fr: "D√©taill√©" },
            film_range: { de: "Start/Endpunkt (Minute)", en: "Start/End point (minute)", es: "Punto de inicio/final (minuto)", fr: "Point de d√©part/fin (minute)" },
            from: { de: "Von Minute", en: "From minute", es: "Desde minuto", fr: "De minute" },
            to: { de: "Bis Minute", en: "To minute", es: "Hasta minuto", fr: "Jusqu‚Äô√† minute" },
            scene_label: { de: "Alternativ: Szene/Minute als Freitext", en: "Alternatively: scene/minute as free text", es: "O alternativamente: escena/minuto como texto libre", fr: "Ou en texte libre: sc√®ne/minute" },
            season: { de: "Staffel", en: "Season", es: "Temporada", fr: "Saison" },
            episode: { de: "Folge", en: "Episode", es: "Episodio", fr: "√âpisode" },
            summarize: { de: "üß† Zusammenfassung erstellen", en: "üß† Create summary", es: "üß† Crear resumen", fr: "üß† Cr√©er r√©sum√©" },
            summary: { de: "üìù Zusammenfassung", en: "üìù Summary", es: "üìù Resumen", fr: "üìù R√©sum√©" },
            read_aloud: { de: "üîä Vorlesen", en: "üîä Read aloud", es: "üîä Leer en voz alta", fr: "üîä Lecture audio" },
            no_result: { de: "üö´ Kein Medium gefunden.", en: "üö´ No media found.", es: "üö´ No se encontr√≥ el medio.", fr: "üö´ Aucun m√©dia trouv√©." },
            chip_from: { de: "Von", en: "From", es: "Desde", fr: "De" },
            chip_to:   { de: "Bis", en: "To", es: "Hasta", fr: "Jusqu‚Äô√†" },
            amazon: { de: "Bei Amazon kaufen", en: "Buy on Amazon", es: "Comprar en Amazon", fr: "Acheter sur Amazon" },
            prime: { de: "Auf Prime ansehen", en: "Watch on Prime", es: "Ver en Prime", fr: "Regarder sur Prime" }
        };
        let langFromPath = "de";
        if (location.pathname.includes("/en/")) langFromPath = "en";
        else if (location.pathname.includes("/es/")) langFromPath = "es";
        else if (location.pathname.includes("/fr/")) langFromPath = "fr";

        setLanguage(langFromPath);
        sessionStorage.setItem('lang', langFromPath); // aktualisiere den Speicher
        function setLanguage(lang) {
            currentLang = lang;
            sessionStorage.setItem('lang', lang);
            document.title = texts.header[lang];
            document.getElementById("header").innerText = texts.header[lang];
            document.getElementById("inputLabel").innerText = "üéûÔ∏è " + texts.input[lang];
            document.getElementById("selectLabel").innerText = texts.select_prompt[lang];
            document.getElementById("detailLabel").innerText = "üîç " + texts.detail_label[lang];
            document.querySelector("#detail option[value='grob']").innerText = "üìù " + texts.short[lang];
            document.querySelector("#detail option[value='detailliert']").innerText = "üìÑ " + texts.detailed[lang];
            document.getElementById("filmRangeLabel").innerText = texts.film_range[lang];
            document.getElementById("filmFromText").innerText = texts.from[lang];
            document.getElementById("filmToText").innerText = texts.to[lang];
            document.getElementById("filmSceneLabel").innerText = texts.scene_label[lang];
            document.getElementById("seriesFromText").innerText = texts.from[lang] + " " + texts.season[lang] + "/" + texts.episode[lang];
            document.getElementById("seriesToText").innerText = texts.to[lang] + " " + texts.season[lang] + "/" + texts.episode[lang];
            document.getElementById("seriesSceneLabelFrom").innerText = texts.scene_label[lang];
            document.getElementById("seriesSceneLabelTo").innerText = texts.scene_label[lang];
            document.querySelectorAll("#summaryBtnFilm, #summaryBtnSeries").forEach(btn=>{
                btn.querySelector("#summarizeText").innerText = texts.summarize[lang];
            });
            document.getElementById("summaryLabel").innerText = texts.summary[lang];
            document.getElementById("ttsText").innerText = texts.read_aloud[lang];
            document.getElementById("amazonBtnText").innerText = texts.amazon[lang];
            document.getElementById("primeBtnText").innerText = texts.prime[lang];
            if (document.getElementById("fromChip").innerText)
                document.getElementById("fromChip").innerText = window._lastFromChip
                    ? `${texts.chip_from[lang]}: ${window._lastFromChip}` : "";
            if (document.getElementById("toChip").innerText)
                document.getElementById("toChip").innerText = window._lastToChip
                    ? `${texts.chip_to[lang]}: ${window._lastToChip}` : "";
        }

        // Sprachauswahl Men√º mittig als Modal
        document.getElementById('lang-btn').onclick = () => {
            let bg = document.getElementById('lang-modal-bg');
            let dd = document.getElementById('lang-dropdown');
            bg.style.display = 'flex';
            dd.style.display = 'block';
        };
        document.querySelectorAll('#lang-dropdown div').forEach((el) => {
            el.onclick = () => {
                setLanguage(el.dataset.lang);
                document.getElementById('lang-modal-bg').style.display = 'none';
                document.getElementById('lang-dropdown').style.display = 'none';
            }
        });
        document.getElementById('lang-modal-bg').onclick = function(e){
            if (e.target === this) { this.style.display = 'none'; document.getElementById('lang-dropdown').style.display = 'none'; }
        };
        setLanguage(currentLang);

        let lastResults = [], selectedItem = null;
        let episodesCache = {}, allEpisodesFlat = [];

        // --- Zwei unabh√§ngige Slider f√ºr Film ---
        let sliderOne, sliderTwo, displayValOne, displayValTwo, minGap = 1, sliderMaxValue;
        function resetDoubleSlider(runtime) {
            sliderOne = document.getElementById("slider-1");
            sliderTwo = document.getElementById("slider-2");
            displayValOne = document.getElementById("range1");
            displayValTwo = document.getElementById("range2");
            sliderMaxValue = runtime;

            sliderOne.min = 1; sliderTwo.min = 1;
            sliderOne.max = runtime; sliderTwo.max = runtime;
            sliderOne.value = 1; sliderTwo.value = runtime;

            displayValOne.textContent = sliderOne.value;
            displayValTwo.textContent = sliderTwo.value;

            sliderOne.oninput = function() {
                if (parseInt(sliderOne.value) >= parseInt(sliderTwo.value) - minGap) {
                    sliderOne.value = parseInt(sliderTwo.value) - minGap;
                }
                displayValOne.textContent = sliderOne.value;
            }
            sliderTwo.oninput = function() {
                if (parseInt(sliderTwo.value) <= parseInt(sliderOne.value) + minGap) {
                    sliderTwo.value = parseInt(sliderOne.value) + minGap;
                }
                displayValTwo.textContent = sliderTwo.value;
            }
        }

        // --- Autocomplete & Media Selection (unver√§ndert) ---
        let debounceTimer;
        document.getElementById("title").oninput = async function(e) {
            clearTimeout(debounceTimer);
            let query = this.value.trim();
            document.getElementById("autocomplete").style.display = "none";
            document.getElementById("selectRow").style.display = "none";
            document.getElementById("detailsSection").style.display = "none";
            document.getElementById("noResult").style.display = "none";
            document.getElementById("buyBtnRow").style.display = "none";
            if (query.length < 2) return;
            debounceTimer = setTimeout(async ()=>{
                let res = await fetch(`/api/search_media?query=${encodeURIComponent(query)}&language=${currentLang}`);
                let arr = await res.json();
                lastResults = arr.filter(r => r.media_type === "movie" || r.media_type === "tv");
                let ac = document.getElementById("autocomplete");
                ac.innerHTML = "";
                if (!lastResults.length) {
                    ac.style.display = "none";
                    document.getElementById("noResult").innerText = texts.no_result[currentLang];
                    document.getElementById("noResult").style.display = "block";
                    return;
                }
                lastResults.slice(0,7).forEach(item => {
                    let name = item.title || item.name;
                    let year = item.release_date ? (" ("+item.release_date.substring(0,4)+")") : "";
                    let div = document.createElement("div");
                    div.className = "autocomplete-item";
                    div.innerText = name + year;
                    div.onmousedown = () => {
                        document.getElementById("title").value = name;
                        ac.style.display = "none";
                        showSelectDropdown();
                    };
                    ac.appendChild(div);
                });
                ac.style.display = "block";
            }, 180);
        };
        document.getElementById("title").addEventListener('keydown', function(e) {
            if (e.key === "Enter") {
                document.getElementById("autocomplete").style.display = "none";
                showSelectDropdown();
            }
        });
        document.addEventListener("mousedown", e => {
            if (!e.target.closest("#autocomplete") && e.target.id !== "title") {
                document.getElementById("autocomplete").style.display = "none";
            }
        });

        function showSelectDropdown() {
            let select = document.getElementById("selectMatch");
            select.innerHTML = "";
            lastResults.forEach((item,i) => {
                let name = item.title || item.name;
                let year = item.release_date ? (" ("+item.release_date.substring(0,4)+")") : "";
                let opt = document.createElement("option");
                opt.value = i;
                opt.text = name + year + " [" + (item.media_type === "movie" ? "Film" : "Serie") + "]";
                select.appendChild(opt);
            });
            document.getElementById("selectRow").style.display = "block";
            select.selectedIndex = 0;
            handleSelection();
        }
        document.getElementById("selectMatch").onchange = handleSelection;

        async function handleSelection() {
            let idx = document.getElementById("selectMatch").value;
            selectedItem = lastResults[idx];
            document.getElementById("detailsSection").style.display = "block";
            document.getElementById("filmSliderSection").style.display = "none";
            document.getElementById("seriesSection").style.display = "none";
            document.getElementById("summarySection").style.display = "none";
            document.getElementById("summaryTextResult").innerText = "";
            document.getElementById("buyBtnRow").style.display = "flex";
            let amazonTitle = (selectedItem.title || selectedItem.name || "").replace(/ /g, "+");
            document.getElementById("amazonBtn").onclick = () => {
                window.open(AMAZON_AFFILIATE_PREFIX + encodeURIComponent(amazonTitle), "_blank");
            };
            document.getElementById("primeBtn").onclick = () => {
                window.open(PRIME_AFFILIATE_PREFIX + encodeURIComponent(amazonTitle), "_blank");
            };

            if (selectedItem.media_type === "movie") {
                document.getElementById("filmSliderSection").style.display = "block";
                let details = await fetch(`/api/get_movie_details?movie_id=${selectedItem.id}`);
                let info = await details.json();
                let runtime = info.runtime || 120;
                resetDoubleSlider(runtime);
            } else if (selectedItem.media_type === "tv") {
                episodesCache = {}; allEpisodesFlat = [];
                let maxSeason = 0;
                for (let s = 1; s <= 20; ++s) {
                    let r = await fetch(`/api/get_episodes?tv_id=${selectedItem.id}&season=${s}`);
                    let eps = await r.json();
                    if (!eps || !eps.length) break;
                    episodesCache[s] = eps;
                    maxSeason = s;
                    eps.forEach(e => allEpisodesFlat.push({season:s, episode:e.episode_number, name:e.name, overview:e.overview}));
                }
                let fromSeason = 1, fromEp = 1, fromScene = "";
                let toSeason = maxSeason, toEp = episodesCache[toSeason].length, toScene = "";
                function renderSeasonEpRow(seasonRowId, epRowId, curSeason, curEp, onSeason, onEp) {
                    let seasonRow = document.getElementById(seasonRowId);
                    let epRow = document.getElementById(epRowId);
                    seasonRow.innerHTML = "";
                    epRow.innerHTML = "";
                    let minus = document.createElement("button");
                    minus.type = "button"; minus.innerText = "-";
                    minus.onclick = () => { if (curSeason > 1) { curSeason--; curEp = 1; onSeason(curSeason); } };
                    let plus = document.createElement("button");
                    plus.type = "button"; plus.innerText = "+";
                    plus.onclick = () => { if (curSeason < maxSeason) { curSeason++; curEp = 1; onSeason(curSeason); } };
                    let label = document.createElement("span");
                    label.innerText = curSeason;
                    label.style.margin = "0 0.6em";
                    seasonRow.appendChild(minus); seasonRow.appendChild(label); seasonRow.appendChild(plus);
                    episodesCache[curSeason].forEach((ep,idx)=>{
                        let span = document.createElement("span");
                        span.className = "ep-box" + (ep.episode_number==curEp ? " selected" : "");
                        span.innerText = ep.episode_number;
                        span.onclick = ()=> {
                            curEp = ep.episode_number;
                            onEp(curEp);
                            if (seasonRowId === "fromSeasonRow") document.getElementById("fromConfirmBtn").click();
                            if (seasonRowId === "toSeasonRow") document.getElementById("toConfirmBtn").click();
                        };
                        epRow.appendChild(span);
                    });
                }
                function showFromBlock() {
                    document.getElementById("fromBlock").style.display = "block";
                    document.getElementById("fromSummary").style.display = "none";
                    document.getElementById("toBlock").style.display = "none";
                    document.getElementById("toSummary").style.display = "none";
                    renderSeasonEpRow("fromSeasonRow", "fromEpisodeRow", fromSeason, fromEp,
                        s=>{fromSeason=s; fromEp=1; showFromBlock();},
                        e=>{fromEp=e; showFromBlock();}
                    );
                    document.getElementById("seriesSceneInputFrom").value = fromScene;
                }
                function showToBlock() {
                    document.getElementById("fromBlock").style.display = "none";
                    document.getElementById("fromSummary").style.display = "block";
                    document.getElementById("toBlock").style.display = "block";
                    document.getElementById("toSummary").style.display = "none";
                    renderSeasonEpRow("toSeasonRow", "toEpisodeRow", toSeason, toEp,
                        s=>{toSeason=s; toEp=1; showToBlock();},
                        e=>{toEp=e; showToBlock();}
                    );
                    document.getElementById("seriesSceneInputTo").value = toScene;
                }
                function showDone() {
                    document.getElementById("fromBlock").style.display = "none";
                    document.getElementById("fromSummary").style.display = "block";
                    document.getElementById("toBlock").style.display = "none";
                    document.getElementById("toSummary").style.display = "block";
                    document.getElementById("summaryBtnSeries").style.display = "block";
                }
                document.getElementById("fromConfirmBtn").onclick = ()=>{
                    fromScene = document.getElementById("seriesSceneInputFrom").value.trim();
                    window._lastFromChip = fromScene ? fromScene : `S${fromSeason}E${fromEp}`;
                    document.getElementById("fromChip").innerText = fromScene
                        ? `${texts.chip_from[currentLang]}: ${fromScene}`
                        : `${texts.chip_from[currentLang]}: S${fromSeason}E${fromEp}`;
                    showToBlock();
                };
                document.getElementById("toConfirmBtn").onclick = ()=>{
                    toScene = document.getElementById("seriesSceneInputTo").value.trim();
                    window._lastToChip = toScene ? toScene : `S${toSeason}E${toEp}`;
                    document.getElementById("toChip").innerText = toScene
                        ? `${texts.chip_to[currentLang]}: ${toScene}`
                        : `${texts.chip_to[currentLang]}: S${toSeason}E${toEp}`;
                    showDone();
                };
                document.getElementById("fromChip").onclick = showFromBlock;
                document.getElementById("toChip").onclick = showToBlock;
                showFromBlock();
                window.getTVSelection = ()=>({
                    fromSeason, fromEp, fromScene,
                    toSeason, toEp, toScene,
                    maxSeason,
                    episodesCache, allEpisodesFlat
                });
                document.getElementById("seriesSection").style.display = "block";
            }
        }

        // Zusammenfassen f√ºr Film
        document.getElementById("summaryBtnFilm").onclick = summarizeFilm;
        async function summarizeFilm() {
            if (!selectedItem) return;
            document.getElementById("summaryTextResult").innerText = "";
            document.getElementById("summarySection").style.display = "none";
            document.getElementById("ttsBtn").style.display = "none";
            document.getElementById("summarizeText").style.display = "none";
            document.getElementById("summaryBtnFilm").disabled = true;
            document.getElementById("summarizeSpinner").style.display = "inline-block";
            let detail = document.getElementById("detail").value;
            let from = document.getElementById("slider-1").value;
            let to = document.getElementById("slider-2").value;
            let scene = document.getElementById("filmSceneInput").value.trim();
            let details = await fetch(`/api/get_movie_details?movie_id=${selectedItem.id}`);
            let info = await details.json();
            let promptReq = {
                title: info.title || "",
                director: info.director || "",
                year: info.release_date ? info.release_date.substring(0,4) : "",
                detail,
                custom_from: scene ? scene : from,
                custom_to: scene ? scene : to,
                overview: info.overview || "",
                lang: currentLang
            };
            let promptRes = await fetch('/api/build_movie_prompt', {
                method: "POST",
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify(promptReq)
            });
            let promptData = await promptRes.json();
            let sumRes = await fetch('/api/summarize_text', {
                method: "POST",
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({prompt: promptData.prompt})
            });
            let sumData = await sumRes.json();
            document.getElementById("summaryTextResult").innerText = sumData.summary || "";
            document.getElementById("summarySection").style.display = "block";
            document.getElementById("ttsBtn").style.display = "inline-block";
            document.getElementById("summarizeSpinner").style.display = "none";
            document.getElementById("summaryBtnFilm").disabled = false;
            document.getElementById("summarizeText").style.display = "inline";
        }
        // Zusammenfassen f√ºr Serie
        document.getElementById("summaryBtnSeries").onclick = async function() {
            if (!selectedItem) return;
            document.getElementById("summaryTextResult").innerText = "";
            document.getElementById("summarySection").style.display = "none";
            document.getElementById("ttsBtn").style.display = "none";
            document.getElementById("summarizeText").style.display = "none";
            document.getElementById("summaryBtnSeries").disabled = true;
            document.getElementById("summarizeSpinner").style.display = "inline-block";
            let detail = document.getElementById("detail").value;
            let sel = window.getTVSelection && window.getTVSelection();
            let fromScene = sel.fromScene;
            let toScene = sel.toScene;
            let useScene = fromScene || toScene;
            let from = fromScene ? fromScene : `S${sel.fromSeason}E${sel.fromEp}`;
            let to = toScene ? toScene : `S${sel.toSeason}E${sel.toEp}`;
            let selectedEpisodes = sel.allEpisodesFlat.filter(ep => {
                let start = (ep.season > sel.fromSeason || (ep.season === sel.fromSeason && ep.episode >= sel.fromEp));
                let end = (ep.season < sel.toSeason || (ep.season === sel.toSeason && ep.episode <= sel.toEp));
                return !useScene ? (start && end) : true;
            });
            let episodes_text = selectedEpisodes.map(ep=>`${ep.name}\n${ep.overview}`).join("\n\n");
            let promptReq = {
                title: selectedItem.name || "",
                detail,
                custom_from: from,
                custom_to: to,
                episodes_summary: episodes_text,
                lang: currentLang
            };
            let promptRes = await fetch('/api/build_tv_prompt', {
                method: "POST",
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify(promptReq)
            });
            let promptData = await promptRes.json();
            let sumRes = await fetch('/api/summarize_text', {
                method: "POST",
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({prompt: promptData.prompt})
            });
            let sumData = await sumRes.json();
            document.getElementById("summaryTextResult").innerText = sumData.summary || "";
            document.getElementById("summarySection").style.display = "block";
            document.getElementById("ttsBtn").style.display = "inline-block";
            document.getElementById("summarizeSpinner").style.display = "none";
            document.getElementById("summaryBtnSeries").disabled = false;
            document.getElementById("summarizeText").style.display = "inline";
        };
        // TTS
        document.getElementById("ttsBtn").onclick = async function() {
            let text = document.getElementById("summaryTextResult").innerText;
            document.getElementById("ttsText").style.display = "none";
            document.getElementById("ttsSpinner").style.display = "inline-block";
            this.disabled = true;
            let res = await fetch('/api/generate_audio_file', {
                method: "POST",
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({text, lang: currentLang})
            });
            let data = await res.json();
            document.getElementById("ttsSpinner").style.display = "none";
            document.getElementById("ttsText").style.display = "inline";
            this.disabled = false;
            if (data.audio_url) {
                let player = document.createElement('audio');
                player.src = data.audio_url;
                player.controls = true;
                player.autoplay = true;
                player.style.marginTop = "1em";
                document.getElementById("summaryTextResult").appendChild(player);
            }
        };
        // Autofill aus Trends
        window.onload = () => {
            let query = sessionStorage.getItem("selected_query") || "";
            if (query) document.getElementById("title").value = query;
            sessionStorage.setItem("selected_query", "");
            if (query.length > 1) document.getElementById("title").dispatchEvent(new Event("input"));
        };

        document.querySelectorAll('#lang-dropdown div').forEach((el) => {
        el.onclick = () => {
            let lang = el.dataset.lang;
            let file = location.pathname.endsWith('video.html') ? 'video.html' : 'book.html';
            let path = "/static/";
            let langPath = (lang === "de") ? path : path + lang + "/";
            window.location.href = langPath + file;
        }
    });
    </script>
</body>
</html>
